---
date: 2014-1-9 13:23:30+00:00
layout: post
title: Android中NDK的使用
thread: 27
categories: android
tags: android
---

Android NDK（Native Development Kit）用于Android项目使用C/C++来实现一些底层、计算量较大或使用第三方库等的功能。

Android NDK通过jni（java native interface）来实现对C/C++的调用，jni适用于所有的java虚拟机。

###jni数据类型###

jni有原始数据类型和数据引用类型。

![](/assets/blog_pic/jni-native.png)

###jni引用类型###

jni的引用类型如下：

![](/assets/blog_pic/jni-interface.png)

###jni的实现步骤###

1.编写并编译java程序

	 public class HelloWorld { 
	    static {
	        
	        System.loadLibrary("Hello");
	        
	    }
	    public     native void DisplayHello();
	    public static void main(String[] args) {
	
	        new HelloWorld().DisplayHello();
	    }
	}

	#javac ./com/zx/HelloWorld.java

2.使用javah生成头文件（`javah -jni com.zx.HelloWorld`）

该头文件不需要用户编译。

	/* DO NOT EDIT THIS FILE - it is machine generated */
	#include <jni.h>
	 /* Header for class com_magc_jni_HelloWorld */
	
	#ifndef _Included_com_zx_HelloWorld
	#define _Included_com_zx_HelloWorld
	#ifdef __cplusplus
	extern "C" {
	#endif
	/*
	 * Class:     com_zx_HelloWorld
	 * Method:    DisplayHello
	 * Signature: ()V
	 */
	JNIEXPORT void JNICALL Java_com_zx_HelloWorld_DisplayHello
	  (JNIEnv *, jobject);
	
	#ifdef __cplusplus
	}
	#endif
	#endif

3.编写本地方法程序

	#include <jni.h>
	#include "com_zx_HelloWorld.h"
	#include <stdio.h>
	JNIEXPORT void JNICALL Java_com_zx_HelloWorld_DisplayHello
	(JNIEnv *env, jobject obj)
	{
	    printf("From jni_helloworldImpl.cpp :");
	    printf("Hello world ! \n");
	    return;
	}

4.生成动态链接库文件

动态链接库文件可以是.dll（只能在windows下使用），也可以是.so文件（在windows下可以通过cygwin来搭建交叉编译环境来生成）。

5.运行java调用jni的本地方法。

###Android NDK的实现步骤###

由于Android是基于linux内核，因此只能使用.so的动态链接库。在windows上开发Android，若使用Android NDK r7之前版本，需要自己利用cygwin来搭建交叉编译环境来生成.so文件。Android NDK r7及以上的版本已经集成了Cygwin编译环境。

配置好Android开发环境后，下载Android NDK，Android NDK的实现步骤如下：

（1）Eclipse -> Window -> Preferences -> Android -> NDK，设置NDK为刚刚解压缩的工具包路径。

（2）NDK环境基本上已经搭建好，新建一个普通Android项目测试NDK支持。项目右键->Android Tools->Add Native Support...，输入.so库名字后点击Finish。此时会在 <project>/jni/目录下生成 Android.mk
和<project>.cpp两个文件

（3）在<project>.cpp中添加本地方法，若在.cpp中使用C语法代码，需要加上`extern "C"`,否则可能会出现`Method 'NewStringUTF' could not be resolved`错误，例如：

	#include <jni.h>
	#include <string.h>
	extern "C"
	{
		jstring Java_com_zx_exerciseapp_MainActivity_stringFromJNI(JNIEnv* env,jobject thiz);
	}
	
	jstring Java_com_zx_exerciseapp_MainActivity_stringFromJNI(JNIEnv* env,jobject thiz)
	{
		return (env)->NewStringUTF("hello from JNI!");
	}

 （4）在Android的java程序中加入调用程序,例如：

	public void onCreate(Bundle savedInstanceState)
	    {
	        super.onCreate(savedInstanceState);
	        TextView  tv = new TextView(this);
	        tv.setText( stringFromJNI() );
	        setContentView(tv);
	    }
	
	public native String  stringFromJNI();
	static {
	        System.loadLibrary("hello-jni");
	    }

（5）Android.mk的代码如下：

	LOCAL_PATH := $(call my-dir)
	include $(CLEAR_VARS)
	LOCAL_MODULE    := ExerciseAPP
	LOCAL_SRC_FILES := ExerciseAPP.cpp
	include $(BUILD_SHARED_LIBRARY)

 （6）编译Android项目，会在<project>/libs/armeabi/目录下生成lib<project>.so文件。

最后，运行即可使用jni的方法了。
