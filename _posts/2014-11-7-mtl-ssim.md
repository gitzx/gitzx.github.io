---
date: 2014-11-7 18:00:30+00:00
layout: post
title: 利用结构相似度(SSIM)检测移动设备贴图丢失
thread: 82
categories: android ios
tags: android ios
---

在之前的文章[移动测试系统功能介绍](http://gitzx.github.io/mtl-system/)中，介绍了移动测试系统的基本功能，系统的结构可简化为下图：

![](/assets/blog_pic/mtl_struct.PNG)

在获取Android或IOS应用尤其是手游在各个设备上的大量截图后，需要查看截图中是否存在贴图丢失或黑边等问题，下面介绍下通过结构相似度（SSIM）来计算参考图像和手持设备对应场景截图的相似度（相似度低认为手持设备中的场景截图不相似），进而判断是否存在贴图丢失这类常见的兼容性问题，并通过图像差分、滤波、边缘检测勾勒出不相似区域，便于观察。

###基本原理###

计算相似度所选用的相似度计算标准是structural similarity  index measurement（SSIM）。由于公式在markdown中不方便排版，这里截成图片。。

![](/assets/blog_pic/formula_ssim.PNG)

以上是数学上的说明，如果你对这个标准没有一个感性的认识，下图中例举了SSIM相似判定的示意图，表格每行的第一列和第二列分别为一个四像素图像（2x2），有三种灰度：黑、白和中灰，表格第三列分别给出了其对应行两幅图像相似的情况。

![](/assets/blog_pic/compare_ssim.PNG)

以第一行为例细说：第一行第一幅图像全黑，均值为0，第二幅图像中灰，均值0.5，而对比度，因为没有像素间的差异，所以对比度是0，结构上也是完全一样，都是一个平面，所以最后判定的结果是亮度不相似，对比度相似，结构相似。第二行和第三行分析方法类似，不一一介绍了。

至于为什么选用SSIM，诸多学术文献上概括了以下优点：

- 主观感知一致性优于传统的度量方式：峰值信噪比和直方图距离
- 能够度量结构上的相似性
- 计算简单，易于编程实现

第二个有点很好理解，因为考虑了结构相似，用协方差表征结构上的相似。第三个比较直观，就是求图像平均值、方差、协方差。第一个问题通俗一点说，就是看上去相似一点的，相似度计算值高，看上去不相似一点的，计算的相似度值低。峰值信噪比和直方图举例在很多地方可不是这样，可以去参看SSIM的原始文献，有实验可以证明这一点。

这几个优点成为选用SSIM的主要原因。除此之外，实际应用中，其百分比的度量方式，以及相似图像和不相似图像之间SSIM的明显落差也成为选用该标准的优点。这两点可以举例说明，参见下图（图像处理经典图片），对几种图像相似度指标计算结果进行比较分析。图2.2给出了三个图像，(a)是原图，(b)是受到弱噪声影响的图，(c)是受到强噪声影响的图，分别计算(b)、(c)和(a)的相似度，其计算选用了三个常见的相似度指标，分别是：PSNR、SSIM和直方图距离。计算的值在图(b)和图(c)的正下方给出。

![](/assets/blog_pic/classic_pic_ssim.PNG)

通过PSNR计算出的相似度分别为32.49，16.83。给出这样两个数据，如果用PSNR做相似度度量，还需要人为的给一个阈值来区分，PSNR大于多少是相似，小于或者等于多少不相似，而这个阈值还有一个很不稳定的变化范围，一句话概括就是用起来麻烦。如果用直方图距离，计算出的分别是96.73%和80.56%，用百分数来衡量，比较符合我用的表述习惯，100%是很相似，但是直方图举例在相似图(图b)变化到不相似（图c）的过程用，没有一个很明显的衰落，直观看数字，会觉得80.56%也是一个比较相似的图像。实际看图c就会觉得这个图已经被噪声污染得不忍直视了。相比之下，SSIM用百分数表示，而且在相似图和非相似图之间有个明显衰落，符合我们一般表述相似的习惯。当然，这是一种很主观的感受，无法严格从学术上说明那个指标好，但是你可以认为，用SSIM体验很好，这点没错。

###实际中需解决的问题###

自动化检测核心是做图像相似度计算和判断。将SSIM推广到实际的移动测试系统中，主要在于解决以下问题：

- 问题1 屏幕分辨率不确定，SSIM只能针对相同尺寸的图像。
- 问题2 截屏的方向不确定
- 问题3 SSIM的指标容易被全局平均

下面将分别介绍如何解决这三个问题。

###插值算法屏幕大小不一###

- 针对问题1 : 屏幕分辨率不确定。

- 解决思路 ：通过图像差值，将图像缩放到相同尺寸。


图像差值的算法有很多，差值的结果只是真实图像的一种近似，无法做到完全还原，所以差值的结果会影响到所计算的SSIM值，这里比较了以下击中差值算法：

（1）最近邻插值[2]

（2）双线性插值算法[3]（Bilinear Interpolation）

（3）双三次插值算法[4]（Bicubic Interpolation）, 

（4）Python PIL库中自带的抗锯齿滤镜。
调用方式：im.resize(size, Image.ANTIALIAS)
实验图像选用四个游戏场景截图（1024x768），在photoshop中将该图缩放到不同的尺寸，用于模拟在不同设别上图像被拉伸到不同的尺寸。各尺寸可以参见下图“不同尺寸对比图在不同算法下的SSIM值”的第二列。

![](/assets/blog_pic/size_ssim.PNG)

上图最后三列给出了最近邻，双线性插值，双三次插值和PIL抗锯齿滤镜得到的图像计算所得SSIM平均值(四幅试验图取平均值)，从表中可以看出，在放大的图像上（对比图3和对比图4）PIL抗锯齿滤镜缩放图像后，得到的结果和原图SSIM的值最大，在缩小的图像上（对比图1和对比图2）双三次插值得到最好的结果，PIL的平滑滤镜第二好。可以得到结论，当用同一个游戏在不同分辨率屏幕下截图，缩放后与参考图像进行比较的时，选用PIL抗锯齿滤镜或者是双三次插值带来的尺寸变化的误差最小，本算法最后选用的是PIL自带的平滑滤镜。

###各个方向分别计算SSIM解决截图方向不一致问题###

- 针对问题2 ：截屏的方向不确定。

- 解决思路： 计算四个方向的SSIM，取四个方向分别计算SSIM，四个SSIM中的最大值所在的方向即是与图像参考图像相似度最高的那个方向，将作为最后结果的方向。由于游戏场景本身的复杂性，所以不会出现差值之后原有方向的图像与参考图的SSIM小于90度、180度、270度旋转后的图像计算出的SSIM。

###图像分块，解决SSIM容易被全局平均问题###

- 针对问题3 ： SSIM容易被全局平均。

- 解决办法 ：将图像划分为固定大小的图像块。分别计算每个图像块的SSIM，取各个块中SSIM的最小值。作为最终的结果。

例如，从下图可以看出，同一张图，有一个小图标的差异，但是计算出的SSIM相似度非常高（99.24%），其原因从其计算方式可以看出，来自于虽然一个白点的差异很显著，但是在全图中被平均了，依然获得非常高的SSIM，这影响是，SSIM受到图像大小的影响，游戏中缺少图标相对于全屏幕小，那么可能出现漏检。

![](/assets/blog_pic/game_example_ssim.PNG)

至于分块的大小，是一个经验值，和你应用中需要关注的分辨率，或者识别精度有关，例如：假设你的判别阈值取值为95%，小于95%的判定为不相似，那么你可以选用最小图标的四倍大小来分块，这样，假设你的最小缺失图标为2x2，分块选为4x4，最坏的情况，一个矩形框只选中了其中1/4（1个像素），假设选中的那个像素完全不相似，那么计算的最小分块的相似度为：15/16 = 93.75%，小于95%。

###Python脚本运行结果###

上面已经介绍完了最核心的部分，判断游戏在设备中的场景截图和参考图像的相似度，从而判断游戏在该设备中是否存在黑屏、红屏或者贴图缺失的问题。之后的工作室为了更方便的识别，我们把不相似的区域标记出来。

流程参见下图。计算SSIM，判断是否相似前面花了比较多篇幅介绍，是算法的核心，至于差分、滤波、边缘检测，都是经典算法。这里就不详细介绍。 

![](/assets/blog_pic/compute_ssim.PNG)

针对常见的两种贴图缺失情况。最终的输出和输出结果如下：

![](/assets/blog_pic/result_ssim.PNG)


###需注意的地方###

该工具能够避免简单的flash动画，例如，随机落叶，云雾动画的影响，但如果场景下有比较大的动画，例如图标的翻转动画，截图的时刻会影响判断结果。其检测过程是简单的，但建立参考图像集的过程会略复杂。因为不同分辨率下通过截图的尺寸变化会带来控件的形变，而实际游戏会对不同分辨率的图像做一些处理，不同分辨率下控件不形变或者控件的位置会有细微的变化。所以，所有设备只用一副参考图像是不够的，而需要针对不同长宽比的设备分别建立参考图集合。

参考：

[1] Z. Wang, A. C. Bovik, H. R. Sheikh, and E. P. Simoncelli. Image quality assessment: From error visibility to structural similarity[J]. IEEE Transaction on Image Processing. 2004, 13(4):600–612

[2] [图像放缩中最近邻插值和双线性插值的基本原理](http://blog.csdn.net/andrew659/article/details/4818988)

[3] [双三次插值](http://zh.wikipedia.org/wiki/%E5%8F%8C%E4%B8%89%E6%AC%A1%E6%8F%92%E5%80%BC)